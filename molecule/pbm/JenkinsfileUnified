#!/usr/bin/env groovy

pipeline {
  agent {
  label 'micro-amazon'
  }
  environment {
      PATH = '/usr/local/bin:/usr/bin:/usr/local/sbin:/usr/sbin:/home/ec2-user/.local/bin'
  }
  parameters {
        choice(
            name: 'REPO',
            description: 'Repo for testing',
            choices: [
                'testing',
                'experimental',
                'main'
            ]
        )
  }
    stages {
        stage('Test PBM packages with PSMDB 3.6') {
            steps {
                script {
                build job: 'percona-backup-mongodb-packages-parallel', parameters: [
                    [$class: 'StringParameterValue', name: 'install_repo', value: env.REPO],
                    [$class: 'StringParameterValue', name: 'psmdb_to_test', value: 'psmdb36']
            ]
                        }
                    }
                }
        stage('Test PBM packages with PSMDB 4.0') {
            steps {
                script {
                build job: 'percona-backup-mongodb-packages-parallel', parameters: [
                    [$class: 'StringParameterValue', name: 'install_repo', value: env.REPO],
                    [$class: 'StringParameterValue', name: 'psmdb_to_test', value: 'psmdb40']
            ]
                        }
                    }
                }
        stage('Test PBM packages with PSMDB 4.2') {
            steps {
                script {
                build job: 'percona-backup-mongodb-packages-parallel', parameters: [
                    [$class: 'StringParameterValue', name: 'install_repo', value: env.REPO],
                    [$class: 'StringParameterValue', name: 'psmdb_to_test', value: 'psmdb42']
            ]
                        }
                    }
                }
                }
}
