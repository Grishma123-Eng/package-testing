- name: Display OS
  debug:
    msg: "OS: {{ ansible_distribution }} {{ ansible_distribution_version }}"

# -------------------------------------------------
# Base dependencies
# -------------------------------------------------

- name: Install packages (Debian)
  apt:
    name:
      - git
      - unzip
      - wget
      - tar
      - python3
      - python3-pip
      - libaio1
      - libnuma1
      - gawk
    update_cache: yes
    state: present
  when: ansible_os_family == "Debian"

- name: Install packages (RHEL / OL / AL)
  dnf:
    name:
      - git
      - unzip
      - wget
      - tar
      - python3
      - python3-pip
      - libaio
      - numactl
      - gawk
      - libtirpc
    state: present
  when: ansible_os_family == "RedHat"

# -------------------------------------------------
# Compute tarball name
# -------------------------------------------------

- name: Set GLIBC version
  set_fact:
    GLIBC_VERSION: >-
      {% if ansible_os_family == 'Debian' %}
        2.35
      {% else %}
        2.34
      {% endif %}

- name: Set tarball name
  set_fact:
    TARBALL_NAME: "Percona-Server-{{ lookup('env','PS_VERSION') }}-Linux.x86_64.glibc{{ GLIBC_VERSION }}.tar.gz"

- name: Set tarball URL
  set_fact:
    TARBALL_URL: "https://downloads.percona.com/downloads/TESTING/ps-{{ lookup('env','PS_VERSION') }}/{{ TARBALL_NAME }}"

# -------------------------------------------------
# Fetch package-testing (ALWAYS under /)
# -------------------------------------------------

- name: Remove any old package-testing
  file:
    path: /package-testing
    state: absent

- name: Download package-testing repo
  command: "{{ item }}"
  args:
    chdir: /
  loop:
    - wget -O package-testing.zip https://github.com/{{ lookup('env','TESTING_GIT_ACCOUNT') | default('Percona-QA') }}/package-testing/archive/{{ lookup('env','TESTING_BRANCH') | default('tarball-fips') }}.zip
    - unzip package-testing.zip
    - rm -f package-testing.zip
    - mv package-testing-* package-testing
  vars:
      branch: "{{ lookup('env', 'TESTING_BRANCH') }}"
      git_account: "{{ lookup('env', 'TESTING_GIT_ACCOUNT') | default('Percona-QA', true) }}"

# -------------------------------------------------
# Ensure test directory exists
# -------------------------------------------------

- name: Ensure PS tarball test directory exists
  file:
    path: /package-testing/binary-tarball-tests/ps
    state: directory
    mode: "0755"

# -------------------------------------------------
# Download tarball INTO run.sh directory
# -------------------------------------------------

- name: Download PS tarball
  get_url:
    url: "{{ TARBALL_URL }}"
    dest: "/package-testing/binary-tarball-tests/ps/{{ TARBALL_NAME }}"
    mode: "0644"

# -------------------------------------------------
# DEBUG â€“ final verification
# -------------------------------------------------

- name: Verify tarball presence
  shell: ls -lh /package-testing/binary-tarball-tests/ps
  register: tarball_debug

- debug:
    var: tarball_debug.stdout_lines

# -------------------------------------------------
# FIPS flags for tests
# -------------------------------------------------

- name: Default FIPS_SUPPORTED
  set_fact:
    FIPS_SUPPORTED: "no"

- name: Enable FIPS for OL9
  set_fact:
    FIPS_SUPPORTED: "yes"
  when:
    - ansible_distribution == "OracleLinux"
    - ansible_distribution_major_version == "9"

- name: Enable FIPS for Debian 12
  set_fact:
    FIPS_SUPPORTED: "yes"
  when:
    - ansible_distribution == "Debian"
    - ansible_distribution_release == "bookworm"

# -------------------------------------------------
# Export environment for run.sh
# -------------------------------------------------

- name: Export test environment
  lineinfile:
    path: /etc/environment
    line: "{{ item }}"
    state: present
  loop:
    - "PS_VERSION={{ lookup('env','PS_VERSION') }}"
    - "PS_REVISION={{ lookup('env','PS_REVISION') }}"
    - "PRO={{ lookup('env','PRO') }}"
    - "FIPS_SUPPORTED={{ FIPS_SUPPORTED }}"