pipeline {
  stages {
    stage ('Get latest code') {
      steps {
        checkout scm
      }
    }
    stage ('Setup Python virtual environment') {
      steps {
        sh '''
        python3 -m venv virtenv
        source virtenv/bin/activate
        pip install pytest molecule ansible wheel  python-vagrant paramiko
        '''
      }
    }
    stage ('Create virtual machines and run playbook for test') {
      steps {
          sh '''
              source virtenv/bin/activate
              cd molecule/pg-11
              molecule --debug converge -s ec2
           '''
     }
    }
    stage ('Start testinfra tests') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule verify -s ec2

         '''
         junit 'molecule/pg-11/molecule/default/*.xml'
        }
    }
    stage ('Start packages deletion') {
      steps {
         sh '''
           source virtenv/bin/activate
           cd molecule/pg-11
           molecule cleanup -s ec2
         '''
        }
    }
  }
   post {
        always {
            sh '''
               source virtenv/bin/activate
               cd molecule/pg-11
               molecule destroy -s ec2
             '''
        }
    }
}